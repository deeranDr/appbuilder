name: Build PremediaApp (macOS & Windows)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    name: üõ†Ô∏è Build macOS App (Intel x64)
    runs-on: macos-15-intel


    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies (macOS Intel)
        run: |
          brew update
          brew install gettext libssh2
          brew link --force gettext
          brew link --force libssh2
      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: 'x64'

      # Cache pip packages
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      # Clear pip cache
      - name: Clear pip cache
        run: pip cache purge
        shell: bash

      - name: Export libssh2 build flags
        run: |
          echo "LDFLAGS=-L$(brew --prefix libssh2)/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix libssh2)/include" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix libssh2)/lib/pkgconfig" >> $GITHUB_ENV


      # Install dependencies
      - name: Install dependencies
        run: |
          echo "Starting dependency installation at $(date)"
          python -m pip install --upgrade pip
          pip install --upgrade wheel setuptools
          echo "Inspecting requirements.txt..."
          cat requirements.txt
          echo "Installing requirements..."
          pip install -r requirements.txt --no-cache-dir --force-reinstall --verbose > requirements_install.log 2>&1 || (echo "‚ùå Failed to install requirements" && cat requirements_install.log && exit 1)
          echo "Installing PySide6 and dependencies..."
          pip install PySide6==6.9.1 PySide6-Essentials==6.9.1 PySide6-Addons==6.9.1 shiboken6==6.9.1 --no-cache-dir --force-reinstall --verbose > pyside6_install.log 2>&1 || (echo "‚ùå Failed to install PySide6" && cat pyside6_install.log && exit 1)
          echo "Installing PyInstaller..."
          pip install pyinstaller==6.14.0 --no-cache-dir --force-reinstall --verbose > pyinstaller_install.log 2>&1 || (echo "‚ùå PyInstaller installation failed" && cat pyinstaller_install.log && exit 1)
          echo "Installing dmgbuild..."
          pip install dmgbuild --no-cache-dir --force-reinstall --verbose > dmgbuild_install.log 2>&1 || (echo "‚ùå dmgbuild installation failed" && cat dmgbuild_install.log && exit 1)
          pip list > installed_packages.txt
          python -m pip show pyinstaller || (echo "‚ùå PyInstaller not installed" && exit 1)
          python -m pip show PySide6 || (echo "‚ùå PySide6 not installed" && exit 1)
          echo "Checking PySide6 plugins..."
          python -c "import PySide6; import os; plugins_path = os.path.join(os.path.dirname(PySide6.__file__), 'Qt/plugins'); print(plugins_path)" > plugins_path.txt
          cat plugins_path.txt
          ls -ld "$(cat plugins_path.txt)/platforms" || (echo "‚ùå PySide6 platforms directory not found" && exit 1)
          ls -ld "$(cat plugins_path.txt)/imageformats" || (echo "‚ùå PySide6 imageformats directory not found" && exit 1)
          find / -name qcocoa.dylib 2>/dev/null > plugin_check.txt || echo "No qcocoa.dylib found" >> plugin_check.txt
          find / -name qicns.dylib 2>/dev/null >> plugin_check.txt || echo "No qicns.dylib found" >> plugin_check.txt
          cat plugin_check.txt
          echo "Dependency installation completed at $(date)"
        shell: bash


      - name: Verify ssh2 runtime
        run: |
          python - << 'EOF'
          import ssh2
          from ssh2.session import Session
          print("ssh2 OK:", ssh2.__file__)
          EOF

      # Upload install logs
      - name: Upload requirements install log
        uses: actions/upload-artifact@v4
        with:
          name: requirements-install-log-macos
          path: requirements_install.log
        if: always()

      - name: Upload PySide6 install log
        uses: actions/upload-artifact@v4
        with:
          name: pyside6-install-log-macos
          path: pyside6_install.log
        if: always()

      - name: Upload PyInstaller install log
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-install-log-macos
          path: pyinstaller_install.log
        if: always()

      - name: Upload dmgbuild install log
        uses: actions/upload-artifact@v4
        with:
          name: dmgbuild-install-log-macos
          path: dmgbuild_install.log
        if: always()

      - name: Upload plugin check log
        uses: actions/upload-artifact@v4
        with:
          name: plugin-check-log-macos
          path: plugin_check.txt
        if: always()

      # Show installed packages
      - name: Show installed packages
        run: cat installed_packages.txt
        shell: bash

      # Verify required files
      - name: Verify required files
        run: |
          test -f app.py || (echo "‚ùå app.py missing" && exit 1)
          test -f login.py || (echo "‚ùå login.py missing" && exit 1)
          test -f icons/premedia.icns || (echo "‚ùå premedia.icns missing" && exit 1)
          test -f icons/photoshop.png || (echo "‚ùå photoshop.png missing" && exit 1)
          test -f icons/folder.png || (echo "‚ùå folder.png missing" && exit 1)
          test -f icons/premedia.png || (echo "‚ùå premedia.png missing" && exit 1)
          test -f icons/vmg-premedia-logo.png || (echo "‚ùå vmg-premedia-logo.png missing" && exit 1)
          test -f terms.txt || (echo "‚ùå terms.txt missing" && exit 1)
          test -f license.txt || (echo "‚ùå license.txt missing" && exit 1)
          test -f login.ui || (echo "‚ùå login.ui missing" && exit 1)
          test -f premediaapp.ui || (echo "‚ùå premediaapp.ui missing" && exit 1)
          test -f icons.qrc || (echo "‚ùå icons.qrc missing" && exit 1)
          test -f icons_rc.py || (echo "‚ùå icons_rc.py missing" && exit 1)
          test -f installer/dmg-settings.py || (echo "‚ùå dmg-settings.py missing" && exit 1)
          test -f installer-assets/dmg-background.bmp || (echo "‚ùå DMG background missing" && exit 1)
          test -f runtime-hook.py || (echo "‚ùå runtime-hook.py missing" && exit 1)
          test -f cache/cache.json || (echo "‚ùå cache.json missing" && exit 1)
        shell: bash


      - name: Build App with PyInstaller
        run: |
          echo "üöÄ Starting PyInstaller build at $(date)"
          python -m py_compile app.py || (echo "‚ùå Syntax error in app.py" && exit 1)

          python -c "import PySide6, os; print(os.path.join(os.path.dirname(PySide6.__file__), 'Qt/plugins'))" > plugins_path.txt
          export PYSIDE6_PLUGINS=$(cat plugins_path.txt)

          LIBSSH2_PATH="$(brew --prefix libssh2)/lib/libssh2.dylib"
          test -f "$LIBSSH2_PATH" || (echo "‚ùå libssh2.dylib not found" && exit 1)

          python -m PyInstaller \
            --log-level=DEBUG \
            --noconfirm \
            --windowed \
            --onedir \
            --name PremediaApp \
            --osx-bundle-identifier com.vmg.premedia \
            --icon=icons/premedia.icns \
            --add-data "icons:icons" \
            --add-data "cache/cache.json:cache" \
            --add-data "terms.txt:." \
            --add-data "license.txt:." \
            --add-data "login.ui:." \
            --add-data "premediaapp.ui:." \
            --add-data "icons.qrc:." \
            --add-data "icons_rc.py:." \
            --add-data "login.py:." \
            --add-data "$PYSIDE6_PLUGINS/platforms:PySide6/Qt/plugins/platforms" \
            --add-data "$PYSIDE6_PLUGINS/imageformats:PySide6/Qt/plugins/imageformats" \
            --add-binary "$LIBSSH2_PATH:." \
            --hidden-import=ssh2.agent \
            --hidden-import=ssh2.channel \
            --hidden-import=ssh2.exceptions \
            --hidden-import=ssh2.sftp \
            --hidden-import=ssh2.sftp_handle \
            --hidden-import=ssh2.pkey \
            --hidden-import=ssh2.listener \
            --hidden-import=ssh2.statinfo \
            --hidden-import=ssh2.knownhost \
            --hidden-import=ssh2.error_codes \
            --hidden-import=ssh2.fileinfo \
            --hidden-import=ssh2.utils \
            --hidden-import=ssh2.publickey \
            --hidden-import=paramiko \
            --hidden-import=requests \
            --hidden-import=cryptography \
            --hidden-import=tzdata \
            --hidden-import=PySide6.QtWidgets \
            --hidden-import=PySide6.QtCore \
            --hidden-import=PySide6.QtGui \
            --hidden-import=PySide6.uic \
            --hidden-import=PIL.Image \
            --hidden-import=login \
            --hidden-import=icons_rc \
            --runtime-hook=runtime-hook.py \
            app.py > pyinstaller.log 2>&1 || (echo "‚ùå PyInstaller failed" && cat pyinstaller.log && exit 1)


      - name: Verify .app bundle exists
        run: |
          test -d dist/PremediaApp.app || (echo "‚ùå PremediaApp.app not generated" && exit 1)



      - name: Fix libssh2 rpath
        run: |
          APP="dist/PremediaApp.app/Contents/MacOS/PremediaApp"
          install_name_tool -add_rpath "@executable_path" "$APP"
          otool -L "$APP"


      # Upload PyInstaller log
      - name: Upload PyInstaller log
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-log-macos
          path: pyinstaller.log
        if: always()

      # Upload plugins path log
      - name: Upload platforms path log
        uses: actions/upload-artifact@v4
        with:
          name: platforms-path-log-macos
          path: plugins_path.txt
        if: always()

      # üìÇ Copy updater.sh into app bundle
      - name: Copy updater.sh into app bundle
        shell: bash
        run: |
          set -euo pipefail

          APP_PATH="dist/PremediaApp.app"
          MACOS_DIR="$APP_PATH/Contents/MacOS"
          SCRIPT_SRC="updater.sh"
          SCRIPT_DST="$MACOS_DIR/updater.sh"

          echo "üîç Verifying app bundle exists..."
          if [[ ! -d "$APP_PATH" ]]; then
            echo "‚ùå ERROR: PremediaApp.app not found at $APP_PATH"
            exit 1
          fi

          echo "üîç Verifying updater.sh exists..."
          if [[ ! -f "$SCRIPT_SRC" ]]; then
            echo "‚ùå ERROR: updater.sh not found in repository root"
            exit 1
          fi

          echo "üìÅ Ensuring MacOS directory exists..."
          mkdir -p "$MACOS_DIR"

          echo "üìÑ Copying updater.sh into app bundle..."
          cp "$SCRIPT_SRC" "$SCRIPT_DST"

          echo "üîí Setting executable permission..."
          chmod 755 "$SCRIPT_DST"

          echo "‚úÖ updater.sh installed successfully:"
          ls -lh "$MACOS_DIR"

      # Sign app
      - name: Sign App
        run: codesign --deep --force --verbose --sign - dist/PremediaApp.app
        if: ${{ env.APPLE_CERTIFICATE == '' }}
        shell: bash

      - name: Sign App with Developer ID
        run: |
          codesign --deep --force --verbose --sign "Developer ID Application: Your Name" --entitlements entitlements.plist dist/PremediaApp.app
        if: ${{ env.APPLE_CERTIFICATE != '' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        shell: bash

      # Inspect built .app
      - name: Inspect built .app
        run: |
          du -sh dist/PremediaApp.app
          find dist/PremediaApp.app
        shell: bash

      # Build DMG
      - name: Build DMG
        run: |
          mkdir -p dmg-build
          cp -R dist/PremediaApp.app dmg-build/
          dmgbuild -s installer/dmg-settings.py \
                   -D app_path="dmg-build/PremediaApp.app" \
                   "PremediaApp" dist/PremediaApp.dmg
        shell: bash


      # s3____generate_version_json_mac
      - name: Update macOS section in version.json
        shell: bash
        run: |
          set -e

          echo "Downloading latest version.json from S3 (if exists)..."
          aws s3 cp s3://vmg-premedia-22112023/application/drn/latest_version.json version.json \
            || echo "version.json not found, using template"

          if [ ! -f version.json ]; then
            echo "Creating base version.json template"
            cat > version.json <<'EOF'
          {
            "version": "1.1.36",
            "release_notes": "Performance improvements and stability fixes",
            "mandatory": false,
            "windows": { "url": "", "sha256": "" },
            "mac": { "url": "", "sha256": "" }
          }
          EOF
          fi

          MAC_URL="https://vmg-premedia-22112023.s3.ap-southeast-2.amazonaws.com/application/drn/macos/PremediaApp_v1.1.36.dmg"
          MAC_SHA=$(shasum -a 256 dist/PremediaApp.dmg | awk '{print $1}')

          echo "macOS SHA256: $MAC_SHA"

          jq --arg url "$MAC_URL" --arg sha "$MAC_SHA" \
            '.mac.url = $url | .mac.sha256 = $sha' \
            version.json > version.tmp.json

          mv version.tmp.json version.json
          cat version.json

          # Verify the update
          if ! jq -e --arg url "$MAC_URL" --arg sha "$MAC_SHA" \
            '.mac.url == $url and .mac.sha256 == $sha' version.json > /dev/null; then
            echo "Failed to update mac section in version.json"
            exit 1
          fi

      - name: ‚òÅÔ∏è Upload macOS Build to S3
        shell: bash
        run: |
          set -e

          echo "üîê Calculating macOS DMG SHA256..."
          MAC_SHA=$(shasum -a 256 dist/PremediaApp.dmg | awk '{print $1}')
          echo "macOS SHA256: $MAC_SHA"

          echo "üìù Injecting macOS SHA into version.json..."
          jq --arg sha "$MAC_SHA" \
            '.mac.sha256 = $sha' \
            version.json > version.tmp.json
          mv version.tmp.json version.json

          echo "‚òÅÔ∏è Uploading macOS DMG..."
          # Ensure aws CLI is installed and available
          aws --version
          aws s3 cp dist/PremediaApp.dmg \
            s3://vmg-premedia-22112023/application/drn/macos/PremediaApp_v1.1.36.dmg \
            --acl public-read

          echo "‚òÅÔ∏è Uploading latest_version.json..."
          aws s3 cp version.json \
            s3://vmg-premedia-22112023/application/drn/latest_version.json \
            --cache-control "no-cache, max-age=0, must-revalidate"

          echo "‚úÖ macOS build uploaded successfully."
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-2


      # Upload DMG artifact
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PremediaApp-macos-dmg
          path: dist/PremediaApp.dmg
          retention-days: 60

  


  build-windows:
    name: ü™ü Build Windows EXE Installer
    runs-on: windows-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: 'x64'

      # Install Visual Studio Build Tools for C++ (required for docopt, psd-tools)
      # - name: Install Visual Studio Build Tools
      #   run: |
      #     echo "Installing Visual Studio Build Tools at $(Get-Date)"
      #     choco install visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended" --no-progress --yes --force
      #     echo "Verifying MSVC installation..."
      #     dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC"
      #     echo "Visual Studio Build Tools installation completed at $(Get-Date)"
      #   shell: powershell

      - name: Install Visual Studio 2022 Build Tools
        run: |
          echo "Installing Visual Studio 2022 Build Tools at $(Get-Date)"
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended" --no-progress --yes --force
          echo "Verifying MSVC installation..."
          $msvcPaths = @(
            "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC",
            "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC"
          )
          $found = $false
          foreach ($path in $msvcPaths) {
            if (Test-Path $path) {
              Write-Host "‚úÖ Found MSVC at: $path"
              dir $path
              $found = $true
              break
            }
          }
          if (-not $found) {
            Write-Error "‚ùå MSVC path not found in either Program Files or Program Files (x86)."
            exit 1
          }
          echo "Visual Studio Build Tools installation completed at $(Get-Date)"
        shell: powershell



      # Cache pip packages
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/AppData/Local/pip/Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      # Clear pip cache
      - name: Clear pip cache
        run: pip cache purge
        shell: powershell

      # Install dependencies
      - name: Verify Python and pip
        run: |
          $ErrorActionPreference = 'Stop'
          echo "Verifying Python and pip at $(Get-Date)"
          echo "Current directory: $(Get-Location)"
          try {
            python --version 2>&1 | Out-File -FilePath python_version.log -Encoding utf8
            if ($LASTEXITCODE -ne 0) {
              echo "Python not found"
              Get-Content python_version.log
              exit 1
            }
            echo "Python version:"
            Get-Content python_version.log
          } catch {
            echo "Error running python --version: $_"
            Get-Content python_version.log
            exit 1
          }
          try {
            python -m pip --version 2>&1 | Out-File -FilePath pip_version.log -Encoding utf8
            if ($LASTEXITCODE -ne 0) {
              echo "pip not found"
              Get-Content pip_version.log
              exit 1
            }
            echo "pip version:"
            Get-Content pip_version.log
          } catch {
            echo "Error running python -m pip --version: $_"
            Get-Content pip_version.log
            exit 1
          }
        shell: powershell
        env:
          pythonLocation: C:\hostedtoolcache\windows\Python\3.9.13\x64
          PKG_CONFIG_PATH: C:\hostedtoolcache\windows\Python\3.9.13\x64/lib/pkgconfig
          Python_ROOT_DIR: C:\hostedtoolcache\windows\Python\3.9.13\x64
          Python2_ROOT_DIR: C:\hostedtoolcache\windows\Python\3.9.13\x64
          Python3_ROOT_DIR: C:\hostedtoolcache\windows\Python\3.9.13\x64

      - name: Upgrade pip
        run: |
          $ErrorActionPreference = 'Stop'
          echo "Upgrading pip at $(Get-Date)"
          $pipUpgradeLog = Join-Path (Get-Location) "pip_upgrade.log"
          try {
            python -m pip install --upgrade pip --verbose 2>&1 | Tee-Object -FilePath $pipUpgradeLog
            if ($LASTEXITCODE -ne 0) {
              echo "Failed to upgrade pip"
              Get-Content $pipUpgradeLog
              exit 1
            }
          } catch {
            echo "Error during pip upgrade: $_"
            Get-Content $pipUpgradeLog
            exit 1
          }
        shell: powershell

      - name: Install Visual C++ Redistributable and wheel/setuptools
        run: |
          $ErrorActionPreference = 'Stop'
          echo "Checking write permissions in $(Get-Location) at $(Get-Date)"
          $testFile = Join-Path (Get-Location) "test_write.txt"
          try {
            echo "Test content" | Out-File -FilePath $testFile -Encoding utf8 -ErrorAction Stop
            if (Test-Path $testFile) {
              echo "Write permission confirmed"
              Remove-Item $testFile -Force
            } else {
              echo "Failed to create test file"
              dir | Out-File -FilePath dir_contents.log -Encoding utf8
              Get-Content dir_contents.log
              exit 1
            }
          } catch {
            echo "Error writing test file: $_"
            dir | Out-File -FilePath dir_contents.log -Encoding utf8
            Get-Content dir_contents.log
            exit 1
          }
          echo "Installing Visual C++ Redistributable..."
          $vcredistLog = Join-Path (Get-Location) "vcredist_install.log"
          try {
            choco install vcredist2015 --no-progress --yes --force 2>&1 | Tee-Object -FilePath $vcredistLog
            if ($LASTEXITCODE -ne 0) {
              echo "Failed to install Visual C++ Redistributable"
              Get-Content $vcredistLog
              exit 1
            }
          } catch {
            echo "Error installing Visual C++ Redistributable: $_"
            Get-Content $vcredistLog
            exit 1
          }
          echo "Installing wheel and setuptools..."
          $wheelSetuptoolsLog = Join-Path (Get-Location) "wheel_setuptools.log"
          try {
            python -m pip install --upgrade wheel setuptools --verbose 2>&1 | Tee-Object -FilePath $wheelSetuptoolsLog
            if ($LASTEXITCODE -ne 0) {
              echo "Failed to install wheel/setuptools"
              Get-Content $wheelSetuptoolsLog
              exit 1
            }
          } catch {
            echo "Error installing wheel/setuptools: $_"
            Get-Content $wheelSetuptoolsLog
            exit 1
          }
        shell: powershell

     
      - name: üõ†Ô∏è Upgrade pip and tools
        run: |
          python -m pip install --upgrade pip==24.3.1 setuptools wheel
          python -m pip config set global.index-url https://pypi.org/simple
      - name: üß© Pre-install docopt-ng to prevent build errors
        run: |
          python -m pip install --only-binary=:all: docopt-ng==0.9.0
      - name: ü©π Patch psd-tools dependency to use docopt-ng (safe fork)
        run: |
          python -m pip install --no-deps psd-tools==1.9.30
      - name: üì¶ Install remaining dependencies
        shell: bash
        run: |
          grep -v "psd-tools" requirements.txt > patched-reqs.txt
          python -m pip install --upgrade --prefer-binary -r patched-reqs.txt
      - name: Verify PySide6 plugin directory
        run: |
          $ErrorActionPreference = 'Stop'
          echo "Trying to detect PySide6 plugins..."
          $defaultPluginsPath = python -c "import PySide6, os; print(os.path.join(os.path.dirname(PySide6.__file__), 'Qt', 'plugins'))"
          echo "Default plugins path: $defaultPluginsPath"
          if (-not (Test-Path $defaultPluginsPath)) {
            echo "Default plugins path not found. Attempting fallback..."
            $fallbackPluginsPath = python -c "import PySide6.QtCore; print(PySide6.QtCore.QLibraryInfo.path(PySide6.QtCore.QLibraryInfo.PluginsPath))"
            echo "Fallback plugins path from QLibraryInfo: $fallbackPluginsPath"
            if (-not (Test-Path $fallbackPluginsPath)) {
              echo "Fallback plugins path also not found!"
              exit 1
            } else {
              echo "‚úÖ Found fallback plugins path: $fallbackPluginsPath"
              dir $fallbackPluginsPath
            }
          } else {
            echo "‚úÖ Found plugins directory: $defaultPluginsPath"
            dir $defaultPluginsPath
          }
        shell: powershell



      - name: Create installed packages list
        run: |
          $ErrorActionPreference = 'Stop'
          echo "Creating installed_packages.txt at $(Get-Date)"
          $installPackagesFile = Join-Path (Get-Location) "installed_packages.txt"
          try {
            python -m pip list --verbose 2>&1 | Out-File -FilePath $installPackagesFile -Encoding utf8
            if ($LASTEXITCODE -ne 0) {
              echo "pip list command failed"
              if (Test-Path $installPackagesFile) {
                echo "Partial output in installed_packages.txt:"
                Get-Content $installPackagesFile
              }
              exit 1
            }
          } catch {
            echo "Error running pip list: $_"
            if (Test-Path $installPackagesFile) {
              echo "Partial output in installed_packages.txt:"
              Get-Content $installPackagesFile
            }
            exit 1
          }
          if (-not (Test-Path $installPackagesFile)) {
            echo "installed_packages.txt not created at $installPackagesFile"
            dir | Out-File -FilePath dir_contents.log -Encoding utf8
            echo "Directory contents:"
            Get-Content dir_contents.log
            exit 1
          }
          echo "Contents of installed_packages.txt:"
          Get-Content $installPackagesFile
        shell: powershell

      - name: Install PyInstaller
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Installing PyInstaller at $(Get-Date)"
          
          try {
            python -m pip install pyinstaller==6.14.0 --no-cache-dir --force-reinstall
            Write-Host "‚úÖ PyInstaller installed successfully."
          }
          catch {
            Write-Error "‚ùå Failed to install PyInstaller: $_"
            exit 1
          }
      - name: Upload all install logs
        uses: actions/upload-artifact@v4
        with:
          name: install-logs-windows
          path: |
            *.log
            installed_packages.txt
        if: always()


      # Show installed packages
      - name: Show installed packages
        run: |
          echo "Current directory: $(Get-Location)"
          if (-not (Test-Path installed_packages.txt)) {
            echo "installed_packages.txt not found"
            dir
            exit 1
          }
          echo "Contents of installed_packages.txt:"
          Get-Content installed_packages.txt
        shell: powershell
        if: always()


      # Upload install logs
      - name: Upload requirements install logs
        uses: actions/upload-artifact@v4
        with:
          name: requirements-install-logs-windows
          path: |
            *.log
        if: always()

      - name: Upload PyInstaller install log
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-install-log-windows
          path: pyinstaller_install.log
        if: always()

      # Show installed packages
      - name: Show installed packages
        run: Get-Content installed_packages.txt
        shell: powershell
        if: always()

      # Verify required files
      - name: Verify required files exist
        run: |
          if (-not (Test-Path app.py)) { echo "app.py missing"; exit 1 }
          if (-not (Test-Path login.py)) { echo "login.py missing"; exit 1 }
          if (-not (Test-Path icons/premedia.ico)) { echo "premedia.ico missing"; exit 1 }
          if (-not (Test-Path icons/photoshop.png)) { echo "photoshop.png missing"; exit 1 }
          if (-not (Test-Path icons/folder.png)) { echo "folder.png missing"; exit 1 }
          if (-not (Test-Path icons/premedia.png)) { echo "premedia.png missing"; exit 1 }
          if (-not (Test-Path icons/vmg-premedia-logo.png)) { echo "vmg-premedia-logo.png missing"; exit 1 }
          if (-not (Test-Path terms.txt)) { echo "terms.txt missing"; exit 1 }
          if (-not (Test-Path license.txt)) { echo "license.txt missing"; exit 1 }
          if (-not (Test-Path login.ui)) { echo "login.ui missing"; exit 1 }
          if (-not (Test-Path premediaapp.ui)) { echo "premediaapp.ui missing"; exit 1 }
          if (-not (Test-Path icons.qrc)) { echo "icons.qrc missing"; exit 1 }
          if (-not (Test-Path icons_rc.py)) { echo "icons_rc.py missing"; exit 1 }
          if (-not (Test-Path installer/installer.iss)) { echo "installer.iss missing"; exit 1 }
          if (-not (Test-Path runtime-hook.py)) { echo "runtime-hook.py missing"; exit 1 }
          if (-not (Test-Path cache/cache.json)) { echo "cache.json missing"; exit 1 }
        shell: powershell

      - name: Install PySide6 and dependencies (Windows)
        run: |
          $ErrorActionPreference = 'Stop'
          echo "Installing PySide6 dependencies at $(Get-Date)"
          $pyside6Log = Join-Path (Get-Location) "pyside6_install.log"
          try {
            python -m pip install PySide6==6.9.1 PySide6-Essentials==6.9.1 PySide6-Addons==6.9.1 shiboken6==6.9.1 `
              --no-cache-dir --force-reinstall --verbose | Tee-Object -FilePath $pyside6Log
            echo "‚úÖ PySide6 installed successfully."
          }
          catch {
            echo "‚ùå Failed to install PySide6. Showing log:"
            if (Test-Path $pyside6Log) {
              Get-Content $pyside6Log
            }
            exit 1
          }
        shell: powershell

      # ‚úÖ Install psutil for updater.py
      - name: Install psutil (required for updater.exe)
        run: |
          echo "Installing psutil for updater build..."
          python -m pip install psutil --no-cache-dir --force-reinstall --verbose
          echo "‚úÖ psutil installed successfully."
          python -c "import psutil; print('psutil version:', psutil.__version__)"
        shell: powershell


      - name: üèóÔ∏è Build with PyInstaller
        run: |
          echo "Running PyInstaller with .spec at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          & python -m PyInstaller app.spec --noconfirm --log-level=DEBUG | Tee-Object -FilePath "$env:GITHUB_WORKSPACE/pyinstaller_output.log"
        shell: pwsh

      #   # üìÇ Copy sayhi.bat into dist folder
      # - name: Copy sayhi.bat into build folder
      #   run: |
      #     echo "üîç Checking if dist/PremediaApp exists..."
      #     if (-not (Test-Path "dist\PremediaApp")) {
      #       echo "üìÅ Folder not found. Creating dist/PremediaApp..."
      #       New-Item -ItemType Directory -Force -Path "dist\PremediaApp" | Out-Null
      #     }
      #     echo "Copying sayhi.bat into dist/PremediaApp..."
      #     Copy-Item -Path "sayhi.bat" -Destination "dist\PremediaApp\" -Force
      #     echo "‚úÖ sayhi.bat copied successfully."
      #     dir dist\PremediaApp
      #   shell: pwsh

# -------------------------------------------------->
      # ‚öôÔ∏è Build updater.exe
      - name: Build updater helper
        run: |
          echo "Building updater.exe..."
          & python -m PyInstaller --onefile updater.py
          echo "‚úÖ updater.exe built successfully"
        shell: pwsh

      # üì¶ Copy updater.exe into final app folder
      - name: Copy updater.exe into build folder
        run: |
          echo "Copying updater.exe into dist/PremediaApp"
          Copy-Item -Path "dist\updater.exe" -Destination "dist\PremediaApp\" -Force
          echo "‚úÖ updater.exe copied into build folder"
          dir dist\PremediaApp
        shell: pwsh

      # üß© Verify updater presence
      - name: Verify updater.exe included
        run: |
          if (-not (Test-Path "dist\PremediaApp\updater.exe")) {
            echo "‚ùå updater.exe missing in dist folder!"
            exit 1
          } else {
            echo "‚úÖ updater.exe present in dist/PremediaApp"
          }
        shell: pwsh
# ------------------------------------------------->




      # Upload PyInstaller log
      - name: Upload PyInstaller log
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-log-windows
          path: pyinstaller.log
        if: always()

      # Check if EXE exists
      - name: Check if EXE exists
        run: |
          echo "Checking dist/PremediaApp/PremediaApp.exe"
          dir dist/PremediaApp
          if (-not (Test-Path dist/PremediaApp/PremediaApp.exe)) {
            echo "ERROR: Executable not found!"
            exit 1
          }
        shell: powershell

      # Install Inno Setup
      - name: üîß Install Inno Setup
        run: choco install innosetup --no-progress --yes --force

      - name: üîß Add Inno Setup to PATH
        run: echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding ascii -Append

      - name: ‚úÖ Verify Inno Setup install
        run: where iscc




      # Build Installer with Inno Setup
      - name: Build Installer with Inno Setup
        run: |
          echo "Starting Inno Setup build at $(Get-Date)"
          echo "Running Inno Setup compiler..."
          iscc installer/installer.iss
          if (-not (Test-Path Output/PremediaApp-Setup.exe)) {
            echo "ERROR: Installer not created!"
            exit 1
          }
          echo "Inno Setup build completed at $(Get-Date)"
        shell: powershell

      # Upload Installer artifact
      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PremediaApp-Windows-Installer
          path: Output/PremediaApp-Setup.exe
          retention-days: 60
      
      ##########################################
      # üîí SECURITY + INTEGRITY VERIFICATION ADDITION
      ##########################################

      # üßÆ Step 1: Generate SHA256 checksum (force lowercase)
      - name: Generate SHA256 checksum (lowercase)
        id: gen_hash
        shell: pwsh
        run: |
          echo "Generating lowercase SHA256 checksum for PremediaApp-Setup.exe"
          $hash = (Get-FileHash "Output/PremediaApp-Setup.exe" -Algorithm SHA256).Hash.ToLower()
          echo "sha256=$hash" >> $env:GITHUB_ENV
          echo $hash | Out-File -FilePath "Output/PremediaApp-Setup.sha256" -Encoding ascii
          Write-Host "‚úÖ SHA256 checksum (lowercase): $hash"
          Get-Content Output/PremediaApp-Setup.sha256

      # üìú Step 2: Verify source integrity
      - name: Verify source integrity
        shell: pwsh
        run: |
          echo "Verifying that build matches latest commit"
          git rev-parse HEAD > latest_commit.txt
          echo "‚úÖ Commit hash:"
          Get-Content latest_commit.txt

      # üîè Step 3: Sign Executable (optional)
      - name: Sign Executable (optional)
        if: env.CODE_SIGN_CERT && env.CODE_SIGN_PASSWORD
        shell: pwsh
        env:
          CODE_SIGN_CERT: ${{ secrets.WINDOWS_CODE_SIGN_CERT }}
          CODE_SIGN_PASSWORD: ${{ secrets.WINDOWS_CODE_SIGN_PASSWORD }}
        run: |
          echo "Starting code signing..."
          & "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe" sign `
            /f "${{ env.CODE_SIGN_CERT }}" `
            /p "${{ env.CODE_SIGN_PASSWORD }}" `
            /tr "http://timestamp.digicert.com" `
            /td sha256 `
            /fd sha256 `
            "Output/PremediaApp-Setup.exe"
          echo "‚úÖ Code signing completed."

      # üß© Step 4: Upload checksum
      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: PremediaApp-Windows-Checksum
          path: Output/PremediaApp-Setup.sha256

      # üß∞ Step 5: Antivirus scan (with detection check)
      - name: Run Windows Defender quick scan
        shell: pwsh
        run: |
          echo "Running Windows Defender quick scan..."
          Start-MpScan -ScanType QuickScan
          $threats = Get-MpThreat
          if ($threats) {
            echo "‚ùå Threats detected by Windows Defender!"
            $threats | Format-Table -AutoSize
            exit 1
          } else {
            echo "‚úÖ No threats detected by Defender."
          }

      # üß™ Step 6: Sandbox execution test
      - name: Sandbox execution test
        shell: pwsh
        run: |
          echo "Launching PremediaApp in sandbox mode for quick test..."
          Start-Process -FilePath "dist/PremediaApp/PremediaApp.exe" -ArgumentList "/testmode" -PassThru | Out-Null
          Start-Sleep -Seconds 5
          echo "‚úÖ Application started successfully."

      # üßæ Step 7: Generate Release Notes
      - name: Generate Release Notes
        shell: pwsh
        run: |
          echo "Creating release notes..."
          echo "PremediaApp Windows Installer Build" > Output/release_notes.txt
          echo "----------------------------------" >> Output/release_notes.txt
          echo "Build Time: $(Get-Date)" >> Output/release_notes.txt
          echo "Commit: $(git rev-parse HEAD)" >> Output/release_notes.txt
          echo "SHA256 Checksum:" >> Output/release_notes.txt
          Get-Content Output/PremediaApp-Setup.sha256 >> Output/release_notes.txt
          echo "" >> Output/release_notes.txt
          echo "Purpose: Official installer for PremediaApp" >> Output/release_notes.txt
          echo "Environment: Windows 10/11 x64" >> Output/release_notes.txt
          echo "Status: Digitally signed and verified" >> Output/release_notes.txt

      # üßæ Step 8: Generate version.json automatically (lowercase hash)
      # - name: Generate version.json
      #   shell: pwsh
      #   run: |
      #     echo "Generating version.json for auto-update..."
      #     $version = "1.1.36"
      #     $hash = "${{ env.sha256 }}"   # ‚úÖ Uses lowercase hash from Step 1
      #     $json = @{
      #       version = $version
      #       windows_url = "https://vmg-premedia-22112023.s3.ap-southeast-2.amazonaws.com/application/drn/windows/PremediaApp_v$version.exe"
      #       mac_url = "https://vmg-premedia-22112023.s3.ap-southeast-2.amazonaws.com/application/drn/macos/PremediaApp_v$version.dmg"
      #       sha256 = $hash
      #       release_notes = "Performance improvements and stability fixes"
      #       mandatory = $false
      #     } | ConvertTo-Json -Depth 3
      #     $json | Out-File -FilePath version.json -Encoding utf8
      #     Get-Content version.json

      - name: Update Windows section in version.json
        shell: pwsh
        run: |
          Write-Host "Downloading latest version.json from S3 (if exists)..."
          aws s3 cp s3://vmg-premedia-22112023/application/drn/latest_version.json version.json `
            || Write-Host "version.json not found, using template"

          if (-not (Test-Path version.json)) {
            Write-Host "Creating base version.json template"
            $baseJson = @"
            {
              "version": "1.1.36",
              "release_notes": "Performance improvements and stability fixes",
              "mandatory": false,
              "windows": { "url": "", "sha256": "" },
              "mac": { "url": "", "sha256": "" }
            }
          "@
                $baseJson | Out-File version.json -Encoding utf8
              }

              $winUrl = "https://vmg-premedia-22112023.s3.ap-southeast-2.amazonaws.com/application/drn/windows/PremediaApp_v1.1.36.exe"
              $winSha = "${{ env.sha256 }}"

              jq --arg url "$winUrl" --arg sha "$winSha" `
                '.windows.url = $url | .windows.sha256 = $sha' `
                version.json > version.tmp.json

              Move-Item version.tmp.json version.json -Force
              Get-Content version.json

              # Verify the update
              $content = Get-Content version.json -Raw | ConvertFrom-Json
              if ($content.windows.url -ne $winUrl -or $content.windows.sha256 -ne $winSha) {
                throw "Failed to update version.json correctly"
              }


      # ‚òÅÔ∏è Step 9: Upload Windows Build to S3
      - name: ‚òÅÔ∏è Upload Windows Build to S3
        shell: pwsh
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-2
        run: |
          echo "Uploading Windows EXE, changelog, and version metadata..."
          aws s3 cp Output/PremediaApp-Setup.exe s3://vmg-premedia-22112023/application/drn/windows/PremediaApp_v1.1.36.exe --acl public-read
          aws s3 cp Output/release_notes.txt s3://vmg-premedia-22112023/application/drn/changelogs/changelog_1.1.36.txt --acl public-read
          aws s3 cp version.json s3://vmg-premedia-22112023/application/drn/latest_version.json --acl public-read --cache-control "no-cache, max-age=60"
          echo "‚úÖ Windows build uploaded successfully."

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: PremediaApp-Release-Notes
          path: Output/release_notes.txt
